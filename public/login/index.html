<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Logowanie – Aplikacja</title>
  <link rel="stylesheet" href="/login/style.css" />
  <!-- Widget Identity (dla sesji i eventów) -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <!-- Spójna logika sesji/nawigacji -->
  <script defer src="/assets/js/auth.js"></script>
</head>
<body>
  <div class="wrapper">
    <div class="tabs" role="tablist" aria-label="Formularze uwierzytelniania">
      <button class="tab-btn active" data-tab="login" role="tab" aria-selected="true">Zaloguj się</button>
    </div>

    <div id="flash" class="flash" aria-live="polite"></div>

    <!-- Logowanie -->
    <form id="login-form" class="form active" autocomplete="on" novalidate>
      <h2>Logowanie</h2>
      <div class="input-field">
        <input type="email" id="login-email" required autocomplete="email" />
        <label for="login-email">Email</label>
      </div>
      <div class="input-field">
        <input type="password" id="login-password" required autocomplete="current-password" />
        <label for="login-password">Hasło</label>
      </div>
      <button id="login-submit" type="submit">Zaloguj się</button>
      <p class="helper">Zapomniałeś hasła? <a id="recover-link" href="#">Odzyskaj dostęp</a></p>
    </form>

    <!-- Brak rejestracji: konta zakładane tylko przez administratora w Netlify -->
  </div>

  <script>
    // UI helpers
    const flash = (msg, type = "") => {
      const box = document.getElementById("flash");
      box.textContent = msg || "";
      box.className = `flash ${type}`;
    };
    const setBusy = (btn, busy, label) => {
      if (!btn) return;
      if (!btn.dataset.label && label) btn.dataset.label = label;
      btn.disabled = !!busy;
      btn.dataset.busy = busy ? "1" : "0";
      if (btn.dataset.label) btn.textContent = busy ? "Przetwarzam..." : btn.dataset.label;
    };

    // Tabs
    // Zakładki zostały usunięte (brak rejestracji)

    document.addEventListener("DOMContentLoaded", () => {
      // Jeżeli już zalogowany i aktywny → przenieś do members
      netlifyIdentity.on("init", (user) => {
        if (user) {
          try {
            const roles = (user.app_metadata && user.app_metadata.roles) || [];
            if (roles.includes('admin') || roles.includes('active')) {
              window.location.replace("/members/");
            }
          } catch(e) {}
        }
      });
      netlifyIdentity.init();

      // Logowanie (bez popupa)
      const loginBtn = document.getElementById("login-submit");
      loginBtn.dataset.label = "Zaloguj się";
      document.getElementById("login-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        flash("");
        const email = document.getElementById("login-email").value.trim();
        const password = document.getElementById("login-password").value;
        if (!email || !password) return flash("Uzupełnij email i hasło.", "warn");

        try {
          setBusy(loginBtn, true);
          await netlifyIdentity.gotrue.login(email, password, true);
          try { await netlifyIdentity.refresh(); } catch {}
          const user = netlifyIdentity.currentUser();
          const roles = (user && user.app_metadata && user.app_metadata.roles) || [];
          const active = roles.includes('admin') || roles.includes('active');
          if (active) {
            flash("Zalogowano. Przenoszę...", "success");
            setTimeout(() => { window.location.replace("/members/"); }, 250);
          } else {
            flash("Konto nieaktywne – zgłoś się do administratora w celu aktywacji.", "warn");
          }
        } catch (err) {
          flash("Błąd logowania: " + (err?.message || err), "error");
        } finally {
          setBusy(loginBtn, false);
        }
      });

      // Reset hasła
      document.getElementById("recover-link").addEventListener("click", async (e) => {
        e.preventDefault();
        const email = document.getElementById("login-email").value.trim();
        if (!email) return flash("Podaj najpierw email w polu logowania.", "warn");
        try {
          await netlifyIdentity.gotrue.requestPasswordRecovery(email);
          flash("Wysłano link do resetu hasła. Sprawdź skrzynkę.", "success");
        } catch (err) {
          flash("Nie udało się wysłać linku: " + (err?.message || err), "error");
        }
      });
    });
  </script>
</body>
</html>
