<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ChemDisk ‚Äì PDF Viewer</title>

  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" href="/assets/logo-chemdisk.svg" />

  <style>
    :root{
      /* ‚Äî‚Äî‚Äî USTAWIENIA MASKI ‚Äî‚Äî‚Äî */
      --mask-gap: 0px;           /* odsuniƒôcie ca≈Çej maski od prawej krawƒôdzi */
      --rail-width: 96px;        /* docelowa szeroko≈õƒá pasa maski */
      --rail-height: 25vh;       /* tylko 25% wysoko≈õci okna */
      --scrollbar-w: 0px;        /* JS wpisze szeroko≈õƒá paska przewijania (je≈õli jest) */
    }

    html, body { height: 100%; margin: 0; background: #0b0b0c; overflow: hidden; }

    /* Iframe z podglƒÖdem */
    #pdfFrame{
      position: fixed; inset: 0; width: 100%; height: 100%;
      border: 0; display: none;
      z-index: 1;
      pointer-events: auto !important;
      background: #000;
    }

    /* Iframe BEZ sandboxa ‚Äì u≈ºywany dla type=3 */
    #pdfFree{
      position: fixed; inset: 0; width: 100%; height: 100%;
      border: 0; display: none;
      z-index: 1;
      pointer-events: auto !important;
      background: #000;
    }

    /* Embed z natywnym viewerem przeglƒÖdarki (type=2) */
    #pdfEmbed{
      position: fixed; inset: 0; width: 100%; height: 100%;
      border: 0; display: none;
      z-index: 1;
      pointer-events: auto !important;
      background: #000;
    }

    /* Object ‚Äì alternatywny natywny viewer PDF (type=3) */
    #pdfObject{
      position: fixed; inset: 0; width: 100%; height: 100%;
      border: 0; display: none;
      z-index: 1;
      pointer-events: auto !important;
      background: #000;
    }

    /* Drobne poprawki dla trybu 1: pe≈Çny viewport i brak nak≈Çadki paska przewijania strony */
    .type1 #pdfFrame{ width: 100vw; height: 100vh; }
    .hide-scrollbar{ scrollbar-width: none; }
    .hide-scrollbar::-webkit-scrollbar{ width:0; height:0; }

    /* Pasek narzƒôdzi (drukuj/pobierz) pokazywany dla type=3 */
    #topBar{
      position: fixed; top: 0; left: 0; right: 0;
      height: 48px; padding: 8px 12px; gap: 8px;
      display: none; align-items: center; justify-content: flex-end;
      z-index: 4; /* ponad maskƒÖ (3) i viewerem (1) */
      background: linear-gradient(180deg, rgba(10,10,12,.92), rgba(10,10,12,.65));
      -webkit-backdrop-filter: blur(6px);
      backdrop-filter: blur(6px);
    }
    #topBar .btn{
      appearance: none; border: 0; border-radius: 8px;
      padding: 8px 12px; font: 14px/1 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color: #eaeaea; background: #1a1b1f; cursor: pointer; opacity: .95;
    }
    #topBar .btn:hover{ opacity: 1; background: #24262b; }

    /* Overlay z komunikatami (lekki) */
    #msg{
      position: fixed; inset: 0; z-index: 2;
      display: grid; place-items: center;
      padding: 24px;
      font: 16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color: #eaeaea; text-align: center;
    }
    #msg b{ color:#fff; }
    #msg[hidden]{ display:none !important; }
    .hint{ opacity:.85; font-size:14px; margin-top:.6rem; }

    /* Root maski nie przechwytuje event√≥w; tylko ‚Äûhitbox‚Äù je ≈Çapie */
    #maskRoot{
      position: fixed; inset: 0; z-index: 3; pointer-events: none;
    }
    #maskRoot[hidden]{ display:none !important; }

    /* Pionowy pas po prawej ‚Äì tylko g√≥rne 25% okna */
    #maskRoot .rail{
      position: absolute;
      top: calc(env(safe-area-inset-top, 0px) + 4px);
      right: calc(var(--mask-gap) + var(--scrollbar-w));
      /* szeroko≈õƒá przyciƒôta o realnƒÖ szeroko≈õƒá paska przewijania strony */
      width: max(0px, calc(var(--rail-width) - var(--scrollbar-w)));
      height: var(--rail-height);
      pointer-events: auto;
      background: transparent;          /* ca≈Çkiem niewidoczna */
      border-bottom-left-radius: 12px;  /* estetyczne zaokrƒÖglenie */
    }

    @media (max-width: 640px){
      :root{
        --rail-width: 72px;   /* wƒô≈ºszy pas na mobile */
      }
    }
  </style>
</head>
<body>
  <iframe id="pdfFrame"
          title="PodglƒÖd PDF (Google Drive)"
          allowfullscreen
          webkitallowfullscreen
          mozallowfullscreen
          referrerpolicy="strict-origin-when-cross-origin"
          sandbox="allow-scripts allow-same-origin allow-forms allow-modals allow-pointer-lock"></iframe>

  <!-- Iframe bez sandboxa dla trybu 3 -->
  <iframe id="pdfFree"
          title="PodglƒÖd PDF (bez sandbox)"
          allowfullscreen
          webkitallowfullscreen
          mozallowfullscreen
          referrerpolicy="strict-origin-when-cross-origin"></iframe>

  <!-- Wariant 2: natywny viewer PDF w przeglƒÖdarce (z toolbar/drukuj/pobierz) -->
  <embed id="pdfEmbed" type="application/pdf" />

  <!-- Wariant 3: alternatywny embed przez <object> (r√≥wnie≈º natywny toolbar) -->
  <object id="pdfObject" type="application/pdf" data="" aria-label="PodglƒÖd PDF"></object>

  <!-- Pasek narzƒôdzi dla trybu 3 -->
  <div id="topBar" aria-hidden="true">
    <a id="dlBtn" class="btn" href="#" download>‚¨á Pobierz</a>
    <button id="printBtn" class="btn" type="button">üñ® Drukuj</button>
  </div>

  <!-- Maska anty-popout (domy≈õlnie: W≈ÅƒÑCZONA; wy≈ÇƒÖcz ?mask=0) -->
  <div id="maskRoot" hidden aria-hidden="true">
    <div class="rail" hidden></div>
  </div>

  <div id="msg" hidden></div>

  <script>
    (() => {
      const $ = (id) => document.getElementById(id);
      const showMsg = (text, hint) => {
        const box = $('msg');
        box.innerHTML =
          '<div><b>' + (text || 'B≈ÇƒÖd') + '</b>' +
          (hint ? '<div class="hint">' + hint + '</div>' : '') +
          '</div>';
        box.hidden = false;
      };

      // ‚Äî‚Äî Parametry: ?id=ID_LUB_LINK [wymagany], ?mode=gview (fallback), ?mask=0 (wy≈ÇƒÖcz maskƒô), ?type=1|2|3 (typ viewera)
      const params = new URLSearchParams(location.search);
      const rawId = (params.get('id') || '').trim();
      const useGView = (params.get('mode') || '').toLowerCase() === 'gview';
      const maskEnabled = (params.get('mask') || '') !== '0';
      const viewerType = (params.get('type') || '1').trim();

      if (!rawId) {
        showMsg('Brak parametru ?id=‚Ä¶',
                'U≈ºyj pe≈Çnego linku do pliku Google Drive lub samego fileId.');
        return;
      }

      // Schowaj parametry z paska adresu (estetyka + ukrycie ID)
      try { history.replaceState(null, '', '/'); } catch {}

      // ‚Äî‚Äî‚Äî Pomiar szeroko≈õci paska przewijania strony (gdy jest widoczny) i zapis do CSS var
      function updateScrollbarWidthVar(){
        const sbw = window.innerWidth - document.documentElement.clientWidth; // 0 na macOS overlay
        document.documentElement.style.setProperty('--scrollbar-w', (sbw > 0 ? sbw : 0) + 'px');
      }
      updateScrollbarWidthVar();
      window.addEventListener('resize', updateScrollbarWidthVar);

      // ‚Äî‚Äî‚Äî W≈ÇƒÖcz maskƒô (wƒÖski pas po prawej, tylko g√≥rne 25% wysoko≈õci)
      // Eksperyment: w typie 1 chowamy maskƒô, w≈ÇƒÖczamy tylko dla type=2
      if (maskEnabled && viewerType === '2') {
        const maskRoot = $('maskRoot');
        maskRoot.hidden = false;
        maskRoot.querySelector('.rail').hidden = false;
      }

      // ‚Äî‚Äî‚Äî WyciƒÖgnij fileId bez serwera/env
      function extractFileId(input){
        const s = String(input).trim();
        // 1) Pe≈Çne linki typu /file/d/ID/
        try {
          const u = new URL(s);
          // /file/d/{id}/...
          let m = u.pathname.match(/\/file\/d\/([\w-]{10,})/i);
          if (m && m[1]) return m[1];
          // open?id=ID lub uc?id=ID
          const idQ = u.searchParams.get('id');
          if (idQ && /[\w-]{10,}/.test(idQ)) return idQ;
        } catch {}
        // 2) Samo fileId
        return /^[\w-]{10,}$/.test(s) ? s : '';
      }

      const fileId = extractFileId(rawId);
      if (!fileId) {
        showMsg('Nie uda≈Ço siƒô rozpoznaƒá ID pliku.', 'Podaj pe≈Çny link do Google Drive lub samo fileId.');
        return;
      }

      // ‚Äî‚Äî‚Äî URL viewer‚Äôa (gview jako fallback)
      // Dla type=2 pokazujemy overlay ‚Äû≈Åadowanie‚Ä¶‚Äù.
      // Dla type=1 i type=3 ‚Äì bez overlay, aby UI Drive by≈Ço w pe≈Çni widoczne.
      if (viewerType === '2') {
        showMsg('≈Åadowanie dokumentu‚Ä¶');
      } else {
        try { $('msg').hidden = true; } catch {}
      }

      const src = useGView
        ? 'https://docs.google.com/gview?embedded=true&url=' +
          encodeURIComponent('https://drive.google.com/uc?export=download&id=' + fileId)
        : 'https://drive.google.com/file/d/' + encodeURIComponent(fileId) + '/preview';
      const directPdf = 'https://drive.google.com/uc?export=download&id=' + encodeURIComponent(fileId);
      const gviewSrc = 'https://docs.google.com/gview?embedded=true&url=' + encodeURIComponent(directPdf);

      // Wyb√≥r trybu viewera wg ?type=
      if (viewerType === '2') {
        // Wariant 2: natywny viewer PDF (z toolbar + pobieranie)
        const emb = $('pdfEmbed');
        emb.src = directPdf;
        // Nie wszystkie przeglƒÖdarki emitujƒÖ "load" dla <embed>
        try { emb.addEventListener('load', () => { $('msg').hidden = true; }); } catch {}
        // Awaryjnie schowaj overlay po kr√≥tkiej chwili
        setTimeout(() => { $('msg').hidden = true; }, 900);
        emb.style.display = 'block';
      } else if (viewerType === '3') {
        // Wariant 3: osadzony preview bez sandboxa (ikony dzia≈ÇajƒÖ, mogƒÖ otwieraƒá nowe karty)
        try { $('msg').hidden = true; } catch {}
        const free = $('pdfFree');
        free.src = src; // najczƒô≈õciej /preview; mo≈ºna te≈º erzec gview gdy ?mode=gview
        free.style.display = 'block';
      } else {
        // Wariant 1 (domy≈õlny): jak by≈Ço ‚Äì Google Drive preview lub gview
        const frame = $('pdfFrame');
        frame.src = src;
        frame.addEventListener('load', () => {
          frame.style.display = 'block';
          $('msg').hidden = true;
        });
        // Klasy poprawiajƒÖce dopasowanie i chowajƒÖce pasek strony
        document.body.classList.add('type1');
        document.documentElement.classList.add('hide-scrollbar');
        document.body.classList.add('hide-scrollbar');
      }

      // Minimalna diagnostyka CSS
      const targetEl = (viewerType === '2') ? $('pdfEmbed') : (viewerType === '3') ? $('pdfFree') : $('pdfFrame');
      const cs = getComputedStyle(targetEl);
      if (cs.pointerEvents === 'none') targetEl.style.pointerEvents = 'auto';

      // ‚Äî‚Äî‚Äî Anty‚Äëkonsolka / utrudnienia (jak w Slides)
      try {
        document.addEventListener('contextmenu', e => e.preventDefault(), { passive:false });
        document.addEventListener('keydown', e => {
          const k = e.key?.toLowerCase();
          if (e.keyCode === 123) return e.preventDefault(); // F12
          if ((e.ctrlKey || e.metaKey) && e.shiftKey && ['i','j','c'].includes(k)) return e.preventDefault();
          if ((e.ctrlKey || e.metaKey) && ['u','s'].includes(k)) return e.preventDefault();
        }, { capture:true });
        const detect = () => {
          const wDiff = window.outerWidth - window.innerWidth;
          const hDiff = window.outerHeight - window.innerHeight;
          return wDiff > 160 || hDiff > 160;
        };
        setInterval(() => {
          if (detect()) {
            document.body.innerHTML = '';
            location.replace('/');
          }
        }, 800);
        try { ['log','info','warn','error','debug'].forEach(m => (console[m] = () => {})); } catch {}
      } catch {}
    })();
  </script>
</body>
</html>
