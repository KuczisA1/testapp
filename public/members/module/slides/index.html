<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ChemDisk – Slides</title>
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta name="color-scheme" content="dark light">
  <style>
    html,body{height:100%;margin:0;background:#000}
    body{min-height:100dvh}
    #stage{position:fixed;inset:0;visibility:hidden}
    iframe{width:100%;height:100%;border:0;display:block;background:#000}
    .error{display:grid;place-items:center;height:100%;font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:24px;text-align:center;color:#e5e7eb;background:#0b1020}
    .error h1{margin:0 0 8px;font-size:20px}
    code{background:#111827;padding:2px 6px;border-radius:6px;color:#e5e7eb}
    @supports (-webkit-touch-callout: none){
      #stage{position:absolute;top:env(safe-area-inset-top);right:env(safe-area-inset-right);bottom:env(safe-area-inset-bottom);left:env(safe-area-inset-left)}
    }
    /* Loader widoczny od razu, zanim schowamy query i zanim iframe się załaduje */
    #loader{position:fixed;inset:0;display:grid;place-items:center;font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#e5e7eb;background:#000}
    #loader[hidden]{display:none}
  </style>
</head>
<body>
  <div id="stage"><noscript>Włącz JavaScript, aby wczytać prezentację.</noscript></div>
  <div id="loader">Ładowanie prezentacji…</div>

  <script>
  (() => {
    const STORAGE_KEY = 'chemdisk_slides_v1';

    const stage  = document.getElementById('stage');
    const loader = document.getElementById('loader');

    // ——— Helpers ———
    const hideQueryNow = () => { try { history.replaceState(null, '', '/'); } catch {} };
    const save = (obj) => { try { sessionStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); } catch {} };
    const load = () => { try { return JSON.parse(sessionStorage.getItem(STORAGE_KEY)||'{}'); } catch { return {}; } };

    const qs = new URLSearchParams(location.search);
    // Jeśli dodasz &keep=1, nie czyścimy query (tryb debug)
    const keep = (qs.get('keep')||'') === '1';

    // 1) Zbierz parametry z URL (jeśli są)
    let rawId     = (qs.get('id')   || '').trim();          // ID lub pełny link
    let mode      = (qs.get('mode') || 'preview').trim().toLowerCase(); // preview | present | embed
    let typeParam = (qs.get('type') || '').trim();          // 1 = preview UI, 2 = embed minimal
    // 2) Jeśli coś jest → zapisz do sessionStorage i NATYCHMIAST wyczyść query, żeby nie było widać ?id=…
    if (rawId || qs.has('mode') || qs.has('type')) {
      save({ rawId, mode, typeParam });
      if (!keep) hideQueryNow();
    }
    // 3) Uzupełnij z pamięci, jeśli czegoś brakuje
    const mem = load();
    rawId     = rawId     || mem.rawId     || '';
    mode      = (qs.has('mode') ? mode : (mem.mode || 'preview'));
    typeParam = typeParam || mem.typeParam || '';

    // Anty-konsolka (jak miałeś)
    try {
      document.addEventListener('contextmenu', e => e.preventDefault(), { passive:false });
      document.addEventListener('keydown', e => {
        const k = e.key?.toLowerCase();
        if (e.keyCode === 123) return e.preventDefault(); // F12
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && ['i','j','c'].includes(k)) return e.preventDefault();
        if ((e.ctrlKey || e.metaKey) && ['u','s'].includes(k)) return e.preventDefault();
      }, { capture:true });
      const detect = () => {
        const wDiff = window.outerWidth - window.innerWidth;
        const hDiff = window.outerHeight - window.innerHeight;
        return wDiff > 160 || hDiff > 160;
      };
      setInterval(() => {
        if (detect()) {
          stage.innerHTML = '';
          document.body.innerHTML = '';
          location.replace('/');
        }
      }, 800);
      try { ['log','info','warn','error','debug'].forEach(m => (console[m] = () => {})); } catch {}
    } catch {}

    // Ekstrakcja ID z pełnego linku/slajdów lub akceptacja „gołego” ID
    function extractId(input){
      const s = String(input||'').trim();
      try {
        const u = new URL(s);
        const byPath  = u.pathname.match(/\/presentation\/d\/([\w-]{10,})/i)?.[1];
        if (byPath) return byPath;
        const byQuery = u.searchParams.get('id');
        if (byQuery && /[\w-]{10,}/.test(byQuery)) return byQuery;
      } catch {}
      return /^[\w-]{10,}$/.test(s) ? s : '';
    }

    try {
      const id = extractId(rawId);
      if (!id) throw new Error('Podaj poprawne ID (parametr ?id=…) lub pełny link Google Slides.');

      const urls = {
        embedUrl:   `https://docs.google.com/presentation/d/${id}/embed?start=false&loop=false&rm=minimal`,
        previewUrl: `https://docs.google.com/presentation/d/${id}/preview`,
        presentUrl: `https://docs.google.com/presentation/d/${id}/present`,
      };

      // Dobór widoku
      let chosen;
      const t = Number(typeParam);
      if (t === 1) {
        chosen = urls.previewUrl;
      } else if (t === 2) {
        chosen = urls.embedUrl; // minimum UI
      } else {
        chosen = mode === 'present' ? urls.presentUrl
               : mode === 'embed'   ? urls.embedUrl
               : urls.previewUrl; // domyślnie preview – najbardziej iframe-friendly
      }

      // Tworzymy iframe, ale stage pokazujemy dopiero po onload
      const iframe = document.createElement('iframe');
      iframe.allowFullscreen = true;
      iframe.setAttribute('allow', 'fullscreen');
      iframe.referrerPolicy = 'strict-origin-when-cross-origin';
      iframe.sandbox = 'allow-scripts allow-same-origin allow-presentation';
      iframe.src = chosen;

      stage.innerHTML = '';
      stage.appendChild(iframe);

      const onLoaded = () => {
        try { loader.hidden = true; } catch {}
        stage.style.visibility = 'visible';
      };
      iframe.addEventListener('load', onLoaded, { once: true });

      // Fallback (opcjonalny): jeśli „present/embed” długo się ładuje, przełącz na preview
      if (t !== 2) {
        const TRY_TIMEOUT = 4500;
        let loaded = false;
        iframe.addEventListener('load', () => { loaded = true; }, { once: true });
        setTimeout(() => {
          if (!loaded && (iframe.src.includes('/present') || iframe.src.includes('/embed'))) {
            iframe.src = urls.previewUrl;
          }
        }, TRY_TIMEOUT);
      }

      // iOS/Safari – re-apply po powrocie z tła
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden && iframe && !iframe.src) iframe.src = chosen;
      });
    } catch (e) {
      try { loader.hidden = true; } catch {}
      stage.style.visibility = 'visible';
      stage.innerHTML = `
        <div class="error">
          <div>
            <h1>Nie udało się załadować prezentacji</h1>
            <p>${e.message}</p>
            <p>Użyj <code>?id=</code> z pełnym linkiem do Slides albo samym ID. Jeśli chcesz wymusić tryb prezentacji, dodaj <code>?mode=present</code> (może wymagać „Opublikuj w internecie”).</p>
          </div>
        </div>`;
      console.error(e);
    }
  })();
  </script>
</body>
</html>
