<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ChemDisk – Slides</title>
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta name="color-scheme" content="dark light">
  <style>
    html,body{height:100%;margin:0;background:#000}
    /* Unikamy znikania paska adresu na mobile oraz bezpieczne marginesy notch */
    body{min-height:100dvh}
    #stage{position:fixed;inset:0}
    iframe{width:100%;height:100%;border:0;display:block;background:#000}
    .error{display:grid;place-items:center;height:100%;font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;padding:24px;text-align:center;color:#e5e7eb;background:#0b1020}
    .error h1{margin:0 0 8px;font-size:20px}
    code{background:#111827;padding:2px 6px;border-radius:6px;color:#e5e7eb}
    /* iOS Safari czasem nakłada przewijanie nad iframe – wymuszamy stały kontener */
    @supports (-webkit-touch-callout: none){
      #stage{position:absolute;top:env(safe-area-inset-top);right:env(safe-area-inset-right);bottom:env(safe-area-inset-bottom);left:env(safe-area-inset-left)}
    }
    /* Loader widoczny do czasu onload iframe */
    #loader{position:fixed;inset:0;display:grid;place-items:center;font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;color:#e5e7eb;background:#000}
    #loader[hidden]{display:none}
  </style>
</head>
<body>
  <div id="stage"><noscript>Włącz JavaScript, aby wczytać prezentację.</noscript></div>
  <div id="loader">Ładowanie prezentacji…</div>
  <script>
  (async () => {
    const stage = document.getElementById('stage');
    const loader = document.getElementById('loader');
    const qs = new URLSearchParams(location.search);
    const rawId  = (qs.get('id') || '').trim();          // ID lub pełny link
    // Domyślnie używamy "preview" (frame-friendly). "present" bywa blokowany nagłówkami X-Frame-Options.
    const mode = (qs.get('mode') || 'preview').trim().toLowerCase(); // preview (domyślnie) | present | embed
    const typeParam = (qs.get('type') || '').trim();     // 1 = z przyciskami, 2 = bez

    // —— Opóźnij ukrycie query, żeby nie zepsuć ładowania na niektórych urządzeniach
    const hideQuerySoon = () => { try { history.replaceState(null, '', '/'); } catch {} };

    // Mini ochrona przed konsolką / podglądem – zostawiamy jak w oryginale
    try {
      document.addEventListener('contextmenu', e => e.preventDefault(), { passive:false });
      document.addEventListener('keydown', e => {
        const k = e.key?.toLowerCase();
        if (e.keyCode === 123) return e.preventDefault(); // F12
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && ['i','j','c'].includes(k)) return e.preventDefault();
        if ((e.ctrlKey || e.metaKey) && ['u','s'].includes(k)) return e.preventDefault();
      }, { capture:true });
      const detect = () => {
        const wDiff = window.outerWidth - window.innerWidth;
        const hDiff = window.outerHeight - window.innerHeight;
        return wDiff > 160 || hDiff > 160; // heurystyka
      };
      setInterval(() => {
        if (detect()) {
          stage.innerHTML = '';
          document.body.innerHTML = '';
          location.replace('/');
        }
      }, 800);
      try { ['log','info','warn','error','debug'].forEach(m => (console[m] = () => {})); } catch {}
    } catch {}

    try {
      const id = (() => {
        const s = String(rawId).trim();
        // Wspieramy: pełny URL /presentation/d/ID, link udostępniania z ?id=, oraz samo ID
        try {
          const u = new URL(s);
          const byPath = u.pathname.match(/\/presentation\/d\/([\w-]{10,})/i)?.[1];
          if (byPath) return byPath;
          const byQuery = u.searchParams.get('id');
          if (byQuery && /[\w-]{10,}/.test(byQuery)) return byQuery;
        } catch {}
        return /^[\w-]{10,}$/.test(s) ? s : '';
      })();

      if (!id) throw new Error('Podaj poprawne ID (parametr ?id=…) lub pełny link Google Slides.');

      // Zbuduj URL-e lokalnie – bez funkcji serverless.
      const urls = {
        embedUrl:   `https://docs.google.com/presentation/d/${id}/embed?start=false&loop=false&rm=minimal`,
        previewUrl: `https://docs.google.com/presentation/d/${id}/preview`,
        presentUrl: `https://docs.google.com/presentation/d/${id}/present`,
      };

      // Dobór widoku – jak w oryginale, z poprawką na widoczność dopiero po load
      let chosen;
      const t = Number(typeParam);
      if (t === 1) {
        chosen = urls.previewUrl;
      } else if (t === 2) {
        // Bez kompromisów: trzymaj się EMBED i nie przełączaj na preview
        chosen = urls.embedUrl;
      } else {
        chosen = mode === 'present' ? urls.presentUrl
               : mode === 'embed'   ? urls.embedUrl
               : urls.previewUrl;
      }

      const iframe = document.createElement('iframe');
      iframe.allowFullscreen = true;
      iframe.setAttribute('allow', 'fullscreen');
      iframe.referrerPolicy = 'strict-origin-when-cross-origin';
      iframe.sandbox = 'allow-scripts allow-same-origin allow-presentation';
      iframe.src = chosen;
      // Ukryj scenę do czasu załadowania (CSS loader na wierzchu)
      stage.style.visibility = 'hidden';
      stage.innerHTML = '';
      stage.appendChild(iframe);

      // —— Pokazuj dopiero po załadowaniu (szczególnie dla type=2)
      const onLoaded = () => {
        try { loader.hidden = true; } catch {}
        stage.style.visibility = 'visible';
        // Dopiero teraz chowamy query z paska
        setTimeout(hideQuerySoon, 200);
      };
      iframe.addEventListener('load', onLoaded, { once: true });

      // Dla trybów innych niż type=2 możemy zachować miękki fallback (present/embed → preview)
      if (t !== 2) {
        const TRY_TIMEOUT = 4500; // ms
        let loaded = false;
        iframe.addEventListener('load', () => { loaded = true; }, { once: true });
        setTimeout(() => {
          if (!loaded) {
            const now = iframe.src;
            if (now.includes('/present') || now.includes('/embed')) {
              iframe.src = urls.previewUrl;
            }
          }
        }, TRY_TIMEOUT);
      }

      // Dodatkowe wzmocnienie stabilności na telefonach: re‑apply src po przywróceniu z tła (iOS/Safari)
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden && iframe && !iframe.src) iframe.src = chosen;
      });
    } catch (e) {
      try { loader.hidden = true; } catch {}
      stage.innerHTML = `
        <div class="error">
          <div>
            <h1>Nie udało się załadować prezentacji</h1>
            <p>${e.message}</p>
            <p>Użyj <code>?id=</code> z pełnym linkiem do Slides albo samym ID. Jeśli chcesz wymusić tryb prezentacji, dodaj <code>?mode=present</code> (może wymagać „Opublikuj w internecie”).</p>
          </div>
        </div>`;
      console.error(e);
    }
  })();
  </script>
</body>
</html>