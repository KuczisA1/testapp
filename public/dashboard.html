<!DOCTYPE html>
<html lang="pl" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <title>Panel Sterowania</title>

    <link rel="stylesheet" href="assets/dashboard/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script defer src="/assets/js/auth.js"></script>

    <!-- Nadpisania bez zmiany globalnego style.css -->
    <style>
      /* Karta/hero na górze: rośnie z treścią i ma luz na dole */
      header { height: auto !important; min-height: 85vh !important; padding-bottom: 40px !important; }

      /* Siatka z dwoma kolumnami na desktopie */
      .settings-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 18px;
        width: min(1100px, calc(100% - 100px));
        margin: 28px 0 0 50px;
      }
      .settings-grid .text-content { width: 100% !important; margin: 0 !important; }
      .stack > .text-content + .text-content { margin-top: 18px !important; }

      /* Na węższych ekranach: jedna kolumna i wewnętrzne marginesy */
      @media (max-width: 950px) {
        header { width: 95% !important; }
        .settings-grid {
          width: calc(100% - 40px);
          margin: 20px;
          grid-template-columns: 1fr;
          gap: 16px;
        }
      }
      @media (min-width: 951px) {
        .settings-grid { grid-template-columns: 1fr 1fr; align-items: start; }
      }

      /* Prosty wygląd panelu nazwy użytkownika */
      #username-panel {
        padding: 16px;
        border-radius: 14px;
        background: rgba(255,255,255,.85);
        border: 1px solid rgba(0,0,0,.08);
      }
      #username-input {
        display: block;
        width: 100%;
        max-width: 420px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(0,0,0,.15);
        background: rgba(255,255,255,.9);
        margin-top: 6px;
      }
      .btn-primary {
        outline: none;
        color: #f2f2f2;
        font-size: 16px;
        font-weight: 500;
        border-radius: 12px;
        padding: 8px 16px;
        border: none;
        cursor: pointer;
        background-image: linear-gradient(135deg,#ff9a9e 10%,#F6416C 100%);
      }

      /* Kafelek z tutorialem (opcjonalnie możesz mieć swoje style) */
      .tutorial-card {
        padding: 16px;
        border-radius: 14px;
        background: rgba(255,255,255,.85);
        border: 1px solid rgba(0,0,0,.08);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .tutorial-card .play {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }
      .tutorial-card i { font-size: 18px; }
    </style>
  </head>
  <body>
    <header>
      <nav class="navbar">
        <div class="logo"><a href="/">ChemDisk</a></div>
        <ul class="menu">
          <li><a href="/">Strona Główna</a></li>
          <li><a href="#settings">Ustawienia Konta</a></li>
        </ul>
        <div class="buttons">
          <input
            type="button"
            value="Wejdź do kursu"
            id="members-link"
            data-href="/members/"
            style="display:none"
          />
          <input type="button" id="logout-link" value="Wyloguj" />
        </div>
      </nav>

      <!-- DWIE KOLUMNY NA DESKTOPIE -->
      <div class="settings-grid">
        <!-- LEWA KOLUMNA -->
        <div class="stack">
          <div class="text-content">
            <h1>Witaj, <span class="js-username">—</span></h1>
            <p>Email: <span id="user-email">—</span></p>
            <p>Nazwa użytkownika: <span class="js-username">—</span></p>
            <p>Status: <span id="user-status" class="code">—</span></p>
            <div id="status-hint" class="notice" style="margin-top:6px;"></div>
          </div>
        </div>

        <!-- PRAWA KOLUMNA -->
        <div class="stack" id="settings">
          <!-- Sekcja: Twoje konto -->
          <div class="text-content">
            <h2>Twoje konto</h2>
            <p>Email (aktualny): <strong id="user-email-current">—</strong></p>
          </div>

          <!-- Sekcja: Profil (nazwa wyświetlana/username) -->
          <div class="text-content">
            <h2>Profil</h2>
            <label for="display-name" style="display:block;margin-top:10px;">Nazwa wyświetlana</label>
            <input
              type="text"
              id="display-name"
              placeholder="np. Jan Kowalski"
              style="display:block;width:100%;max-width:420px;padding:10px 12px;border-radius:12px;border:1px solid rgba(0,0,0,.15);background:rgba(255,255,255,.85);margin-top:6px;"
            />
            <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:12px;">
              <input
                type="button"
                id="save-profile"
                value="Zapisz profil"
                class="btn-primary"
              />
              <span id="profile-msg" class="notice" style="min-height:1.2em;"></span>
            </div>
          </div>

          <!-- Sekcja: Hasło (link odzyskiwania) -->
          <div class="text-content">
            <h2>Hasło</h2>
            <p style="margin-top:8px;">Wyślemy na Twój e-mail link do ustawienia nowego hasła.</p>
            <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:12px;">
              <input
                type="button"
                id="send-recovery"
                value="Wyślij link do zmiany hasła"
                class="btn-primary"
              />
              <span id="pass-msg" class="notice" style="min-height:1.2em;"></span>
            </div>
          </div>

          <!-- Sekcja: Zmiana e-maila -->
          <div class="text-content">
            <h2>E-mail</h2>
            <label for="new-email" style="display:block;margin-top:10px;">Nowy e-mail</label>
            <input
              type="email"
              id="new-email"
              placeholder="nowy@adres.pl"
              style="display:block;width:100%;max-width:420px;padding:10px 12px;border-radius:12px;border:1px solid rgba(0,0,0,.15);background:rgba(255,255,255,.85);margin-top:6px;"
            />
            <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:12px;">
              <input
                type="button"
                id="save-email"
                value="Zmień e-mail"
                class="btn-primary"
              />
              <span id="email-msg" class="notice" style="min-height:1.2em;"></span>
            </div>
            <p class="muted" style="margin-top:24px; margin-bottom: 20px;">
              Uwaga: zmiana e-maila może wymagać potwierdzenia linkiem wysłanym na nowy adres.
            </p>
          </div>
        </div>
      </div>
      <!-- /settings-grid -->
    </header>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const $ = (id) => document.getElementById(id);
        const hasIdentity = () => typeof window !== "undefined" && !!window.netlifyIdentity;

        // „Wejdź do kursu”
        const membersBtn = $("members-link");
        if (membersBtn) {
          membersBtn.addEventListener("click", function () {
            const url = membersBtn.dataset.href || "/members/";
            window.location.href = url;
          });
        }
        // Akcje ustawień
        const setBusy = (btn, busy) => { if (!btn) return; btn.disabled = !!busy; btn.style.opacity = busy ? '0.7' : ''; };

        const saveProfileBtn = $("save-profile");
        if (saveProfileBtn) {
          saveProfileBtn.addEventListener("click", async () => {
            const msg = $("profile-msg");
            const name = ($("display-name")?.value || '').trim();
            const user = hasIdentity() && window.netlifyIdentity.currentUser();
            if (!user) { if (msg) msg.textContent = 'Musisz być zalogowany.'; return; }
            setBusy(saveProfileBtn, true);
            if (msg) msg.textContent = 'Zapisywanie...';
            try {
              await user.update({ data: { name } });
              try { await user.jwt(true); } catch {}
              if (msg) msg.textContent = 'Zapisano.';
            } catch (e) {
              if (msg) msg.textContent = 'Błąd zapisu: ' + (e?.message || 'spróbuj ponownie');
            } finally {
              setBusy(saveProfileBtn, false);
            }
          });
        }

        const passBtn = $("send-recovery");
        if (passBtn) {
          passBtn.addEventListener('click', () => {
            const msg = $("pass-msg");
            if (!hasIdentity() || !window.netlifyIdentity.currentUser()) {
              if (msg) msg.textContent = 'Musisz być zalogowany.';
              return;
            }
            window.netlifyIdentity.open('recovery');
            if (msg) msg.textContent = 'Jeśli adres istnieje, wyślemy link do zmiany hasła.';
          });
        }

        const emailBtn = $("save-email");
        if (emailBtn) {
          emailBtn.addEventListener('click', async () => {
            const msg = $("email-msg");
            const newEmail = ($("new-email")?.value || '').trim();
            const user = hasIdentity() && window.netlifyIdentity.currentUser();
            if (!user) { if (msg) msg.textContent = 'Musisz być zalogowany.'; return; }
            if (!newEmail || !/^\S+@\S+\.\S+$/.test(newEmail)) {
              if (msg) msg.textContent = 'Podaj poprawny adres e-mail.';
              return;
            }
            setBusy(emailBtn, true);
            if (msg) msg.textContent = 'Zapisywanie...';
            try {
              await user.update({ email: newEmail });
              try { await user.jwt(true); } catch {}
              const emailEl1 = document.querySelector('#user-email');
              const emailEl2 = document.querySelector('#user-email-current');
              if (emailEl1) emailEl1.textContent = newEmail;
              if (emailEl2) emailEl2.textContent = newEmail;
              if (msg) msg.textContent = 'Zmieniono e-mail. Sprawdź skrzynkę (może być wymagane potwierdzenie).';
            } catch (e) {
              if (msg) msg.textContent = 'Błąd zmiany e-maila: ' + (e?.message || 'spróbuj ponownie');
            } finally {
              setBusy(emailBtn, false);
            }
          });
        }
      });
    </script>
  </body>
</html>
