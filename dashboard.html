<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard – Chemdisk</title>
  <link rel="stylesheet" href="/assets/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/gotrue-js@1.5.0/dist/gotrue.min.js"></script>
  <script defer src="/assets/js/auth.js"></script>
  <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:40px;}button{padding:.5rem 1rem;margin-right:.5rem}</style>
</head>
<body>
  <h1>Dashboard</h1>
  <div id="user-box" style="margin-bottom:1rem"></div>
  <div id="status-box" style="margin-bottom:1rem"></div>
  <div id="actions">
    <a id="members-link" href="/members/" style="display:none">Wejdź do strefy members</a>
    <button id="logout-btn">Wyloguj</button>
  </div>
  <p style="margin-top:1rem"><a href="/">Strona główna</a></p>

  <script>
    const fmtDate = (d) => new Date(d).toLocaleString('pl-PL');

    async function load() {
      const user = window.chemdiskAuth.currentUser();
      if (!user) {
        window.location.href = '/login.html';
        return;
      }

      // Zsynchronizuj wygasłe członkostwa do pending
      await window.chemdiskAuth.syncPendingIfExpired();

      const effective = window.chemdiskAuth.effectiveMembership(window.chemdiskAuth.currentUser());
      const expiresAt = effective.expiresAt ? fmtDate(effective.expiresAt) : 'brak (nie wygasa)';
      document.getElementById('user-box').textContent = `Zalogowano jako: ${user.email}`;
      document.getElementById('status-box').innerHTML = `
        <div>Rola: <strong>${effective.role}</strong></div>
        <div>Status członkostwa: <strong>${effective.status}</strong></div>
        <div>Start: ${effective.startedAt ? fmtDate(effective.startedAt) : '—'}</div>
        <div>Wygasa: ${expiresAt}</div>
      `;

      // Members widoczny tylko gdy nie pending
      const canAccessMembers = effective.status !== 'pending';
      document.getElementById('members-link').style.display = canAccessMembers ? 'inline-block' : 'none';
    }

    document.getElementById('logout-btn').addEventListener('click', async () => {
      await window.chemdiskAuth.logout();
      window.location.href = '/';
    });

    load();
  </script>
</body>
</html>
